"use strict";function handlersProfileView(){$("#request-roommate").on("click",function(){var e=this;$.ajax({url:"/requests/invite",type:"POST",data:{user_id:$("#user_id").val()},success:function(t){switch(t.status){case"ok":$(e).after($('<p class="roommate-status">Соседство: в ожидании ответа от пользователя '+$("#user_first_name").val()+" &#x029D6;</p>")),$(e).remove();break;case"not ok":alert("При попытке предложить соседство произошла ошибка")}},error:function(){console.log("Ошибка интернет-соединения")}})}),$("#request-complain").on("click",function(e){e.preventDefault(),$.ajax({method:"GET",url:"/requests/ajax_get_form_complain",success:function(e){complainForm(e)},error:function(e){alert("Ошибка интернет-соединения")}})}),$("#btn-edit-user-info").on("click",function(e){e.preventDefault(),window.location.href="/profile/edit/"+$("#user_id").val()}),$("#btn-showflat").on("click",function(e){e.preventDefault(),opencloseFlatInfo()}),$("#btn-showhide-flat").on("click",function(){opencloseFlatInfo()}),$(".photos").magnificPopup({delegate:"a",type:"image",gallery:{enabled:!0,tPrev:'Предыдущее (Стрелка "Влево")',tNext:'Следующее (Стрелка "Вправо")'},preload:[1,3]})}function handlersProfileEdit(){$("#user_birth_date").datepicker({dayNames:["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],dayNamesShort:["Пон","Вто","Сре","Чет","Пят","Суб","Вос"],dayNamesMin:["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Янв","Фев","Мар","Апр","Май","Инь","Иль","Авг","Сен","Окт","Ноя","Дек"],dateFormat:"dd.mm.yy",changeYear:!0,changeMonth:!0,yearRange:"1980:2013"}),$("#flat_enter_date").datepicker({dayNames:["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],dayNamesShort:["Пон","Вто","Сре","Чет","Пят","Суб","Вос"],dayNamesMin:["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Янв","Фев","Мар","Апр","Май","Инь","Иль","Авг","Сен","Окт","Ноя","Дек"],dateFormat:"dd.mm.yy"}),$("#user_phone").mask("+7(999)-999-99-99"),$("#user_university").on("change",function(){loadFaculties(processInputSelect("user_university"))}),$("#user_faculty").on("change",function(){loadDepartments(processInputSelect("user_faculty"))}),$(".room-photos > div > a").on("click",function(e){e.preventDefault();var t=$(this).parent().attr("id");deletePhoto(t)}),$("#btn-showflat").on("click",function(e){e.preventDefault(),$(".room-info").fadeIn(200)}),$("#user_avatar_1, #upload-icon").on("click",function(){$("#user_avatar_2").click()}),$("#user_avatar_2").on("change",function(){if(this.files[0]){if(this.files[0].size>5242880)return void alert("Размер загружаемой фотографии не должен превышать 5 мб");var e=new FormData;e.append("upload",this.files[0],this.files[0].name),e.append("user_id",$("#user_id").val()),$.ajax({url:"/profile/upload_avatar",type:"POST",data:e,processData:!1,contentType:!1,success:function(e){switch(e.status){case"ok":$("#user_avatar_1").attr("src",e.user_avatar);break;case"not ok":alert("Произошла ошибка при загрузке фотографии")}},error:function(){console.log("Ошибка интернет-соединения")}})}}),$("#btn-photo-add").on("click",function(){$("#files").click()}),$("#files").on("change",function(){var e=$("#files").get(0).files;if(0!==e.length){if(e.length>1)return void alert("Можно загружать не более 1 фото за раз");for(var t=[],a=[],r=0;r<e.length;r++)e[r].size<=5242880?t.push(e[r]):(alert("Фото '"+e[r].name+"' превышает допустимый размер в 5 мб"),a.push(e[r]));for(var o=new FormData,r=0;r<t.length;r++)o.append("uploads",t[r],t[r].name);$.ajax({url:"/profile/upload_photos",type:"POST",data:o,processData:!1,contentType:!1,success:function(e){switch(e.status){case"ok":for(var t=[],a=0;a<e.newPhotos.length;a++)t.push($('<div id="flat-photo-'+e.newPhotos[a].id+'"></div>').append($('<img src="'+e.newPhotos[a].href+'" alt="'+e.newPhotos[a]+'" />')).append($('<a href="#">Удалить</a>').on("click",function(e){e.preventDefault();var t=$(this).parent().attr("id");deletePhoto(t)})));$("#btn-photo-add").parent().before(t);break;case"not ok":alert("Ошибка при загрузке фото")}},error:function(){console.log("Ошибка интернет-соединения")}})}}),$("#btn-saveall").on("click",function(e){if(e.preventDefault(),validateUserInfo()){var t={user:{}};t.user.id=$("#user_id").val(),t.user.about=$("#user_about").val(),t.user.first_name=$("#user_first_name").val(),t.user.last_name=$("#user_last_name").val(),t.user.sex=processInputSelect("user_sex"),t.user.birth_date=$("#user_birth_date").val(),t.user.phone=$("#user_phone").val(),t.user.email=$("#user_email").val(),t.user.city=$("#user_city").val(),t.user.university=processInputSelect("user_university"),t.user.faculty=processInputSelect("user_faculty"),t.user.department=processInputSelect("user_department"),t.user.studyyear=processInputSelect("user_studyyear"),t.user.wish_pay=$("#user_wish_pay").val(),t.priority=[],$(".priority").each(function(){t.priority.push(processInputSelect(this.id))});var a=!1;if(hasFlat()){if(console.log("has flat = true"),!validateFlat())return void(a=!0);t.flat={},t.flat.id=$("#flat_id").val(),t.flat.description=$("#flat_description").val(),t.flat.address=$("#flat_address").val(),t.flat.square=$("#flat_square").val(),t.flat.room_num=$("#flat_room_num").val(),t.flat.traffic=$("#flat_traffic").val(),t.flat.total_pay=$("#flat_total_pay").val(),t.flat.rent_pay=$("#flat_rent_pay").val(),t.flat.enter_date=$("#flat_enter_date").val(),t.utility=[],$("#utility > label > [type=checkbox]").each(function(){$(this).prop("checked")&&t.utility.push($(this).val())})}a||(console.log("flat validated successfully, flat = ",t.flat,", utility =",t.utility),$.ajax({method:"POST",url:"/profile/edit",dataType:"json",data:t,success:function(e){"ok"===e.status?(alert("Информация сохранена"),window.location.href="/profile/view/"+$("#user_id").val()):alert("При загрузке данных произошла ошибка")},error:function(){alert("Проверьте соединение с Интернетом")}}))}})}function loadFaculties(e){console.log("loadFaculties"),""!==e?$.ajax({method:"GET",url:"/profile/get_faculties/"+processInputSelect("user_university"),success:function(e){if("ok"===e.status){for(var t=$("#user_faculty").html(""),a=0;a<e.faculties.length;a++)t.append($('<option value="'+e.faculties[a].id+'">'+e.faculties[a].name_full+"</option>"));t.on("change",function(){console.log("faculties changed"),loadDepartments(processInputSelect("user_faculty"))}),loadDepartments(processInputSelect("user_faculty")),$("#user_department").html('<option value="0">Не выбрана</option>')}else console.log('При загрузке факультетов для ВУЗА id="'+processInputSelect("user_university")+'" произошла ошибка');enableAllControls()},error:function(e){console.log("Ошибка сетевого соединения"),enableAllControls()}}):($("#user_faculty").html('<option value="">Не выбран</option>'),loadDepartments(""))}function loadDepartments(e){console.log("loadDepartments"),console.log("faculty_id=",e),""!==e?$.ajax({method:"GET",url:"/profile/get_departments/"+processInputSelect("user_faculty"),success:function(e){for(var t=$("#user_department").html(""),a=0;a<e.departments.length;a++)t.append($('<option value="'+e.departments[a].id+'">'+e.departments[a].name_full+"</option>"))},error:function(e){console.log("Ошибка сетевого соединения"),enableAllControls()}}):$("#user_department").html('<option value="">Не выбрана</option>')}function deletePhoto(e){var t=e.match(/^flat-photo-(\d+)$/)[1];$.ajax({url:"/profile/delete_photo/",type:"DELETE",data:{photo_id:t},success:function(e){switch(e.status){case"ok":$("#flat-photo-"+t).remove();break;case"not ok":alert("Ошибка при удалении фото")}},error:function(){console.log("Ошибка интернет-соединения")}})}function doCrop(e){$("#avatar-cropper").attr("src",e.user_avatar);var t=new Cropper($("#avatar-cropper").get(0),{aspectRatio:1});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(e,t,a){var r=this;setTimeout(function(){for(var o=atob(r.toDataURL(t,a).split(",")[1]),l=o.length,n=new Uint8Array(l),s=0;l>s;s++)n[s]=o.charCodeAt(s);e(new Blob([n],{type:t||"image/png"}))})}}),$("#btn-crop").on("click",function(){t.getCroppedCanvas().toBlob(function(e){var t=new FormData;console.log("blob=",e),t.append("upload",e,"upload"),t.append("user_id",$("#user_id").val()),$.ajax("/profile/upload_avatar",{method:"POST",data:t,processData:!1,contentType:!1,success:function(e){console.log(e),"ok"===e.status?($("#user_avatar_1").attr("src",e.user_avatar),closePopup()):alert("При загрузке аватара произошла ошибка")},error:function(){alert("Ошибка интернет-соединения")}})})}),showPopup()}function complainForm(e){$(".popup-content.complain-form").html(e),$("#btn-send-complain").on("click",function(e){return e.preventDefault(),$("#complain-comment").val().length>500?(alert("Длина поля 'Комментарий' не может превышать 500 символов"),void $("#complain-comment").focus()):void $.ajax({method:"POST",url:"/requests/complain/",data:{user_id:$("#user_id").val(),complain_id:processInputSelect("complain-reason"),complain_comment:$("#complain-comment").val()},success:function(e){"ok"===e.status?(alert("Ваша жалоба принята. Нам очень важна Ваша активность. Спасибо!"),closePopup()):"NO_AVAILABLE_COMPLAINS"===e.reason?(alert("Вы отправили максимальное количество жалоб на этой неделе"),closePopup()):"COMPLAIN_IS_ALREADY_EXISTS"===e.reason?(alert("Вы уже отправляли жалобу на этого пользователя"),closePopup()):(alert("При подаче жалобы произошла ошибка. Наверное Вы пожаловались на сына/дочку мэра. Извините, за Вами уже выехали."),closePopup())},error:function(e){alert("Ошибка сетевого соединения"),closePopup()}})}),showPopup()}function validateUserInfo(){var e=$("#user_first_name").val();if(""===e||" "===e)return alert("Поле 'Ваше имя' не может быть пустым"),$("#user_first_name").focus(),!1;if(e.length>100)return alert("Поле 'Ваше имя' не может быть длиннее 100 символов"),$("#user_first_name").focus(),!1;var t=$("#user_last_name").val();if(""===t||" "===t)return alert("Поле 'Ваша фамилия' не может быть пустым"),$("#user_last_name").focus(),!1;if(t.length>100)return alert("Поле 'Ваша фамилия' не может быть длиннее 100 символов"),$("#user_last_name").focus(),!1;var a=$("#user_birth_date").val();if(""===a||" "===a)return alert("Поле 'Дата рождения' не может быть пустым"),$("#user_birth_date").focus(),!1;var r=$("#user_phone").val();if(""===r||" "===r)return alert("Поле 'Номер мобильного' не может быть пустым"),$("#user_phone").focus(),!1;if(!r.match(/^((8|\+7)[\- ]?)?(\(?\d{3}\)?[\- ]?)?[\d\- ]{7,10}$/))return alert("Поле 'Номер мобильного' заполнено неправильно"),$("#user_phone").focus(),!1;if(r.length>50)return alert("Поле 'Номер мобильного' не может быть длиннее 50 символов"),$("#user_phone").focus(),!1;var o=$("#user_email").val();if(""===o||" "===o)return alert("Поле 'Ваш email' не может быть пустым"),$("#user_email").focus(),!1;if(o.length>100)return alert("Поле 'Ваш email' не может быть длиннее 100 символов"),$("#user_email").focus(),!1;if(!o.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/))return alert("Поле 'Ваш email' заполнено неправильно"),$("#user_email").focus(),!1;var l=$("#user_city").val();if(""===l||" "===l)return alert("Поле 'Страна Вашего ВУЗа' не может быть пустым"),$("#user_city").focus(),!1;if(l.length>100)return alert("Поле 'Страна Вашего ВУЗа' не может быть длиннее 100 символов"),$("#user_city").focus(),!1;var n=$("#user_wish_pay").val();return""===n||" "===n?(alert("Поле 'Сколько готов(а) платить за жилье' не может быть пустым"),$("#user_wish_pay").focus(),!1):n.match(/^\d+$/)?!0:(alert("Поле 'Сколько готов(а) платить за жилье' должно быть числом"),$("#user_wish_pay").focus(),!1)}function validateFlat(){var e=$("#flat_description").val();if(""!==e&&" "!==e&&e.length>200)return alert("Поле 'Описание квартиры' не может быть длиннее 200 символов"),$("#flat_description").focus(),!1;var t=$("#flat_address").val();if(""===t||" "===t)return alert("Поле 'Адресс' не может быть пустым"),$("#flat_address").focus(),!1;if(t.length>200)return alert("Поле 'Адресс' не может быть длиннее 200 символов"),$("#flat_address").focus(),!1;var a=$("#flat_square").val();if(""===a||" "===a)return alert("Поле 'Площадь' не может быть пустым"),$("#flat_square").focus(),!1;if(a.length>50)return alert("Поле 'Площадь' не может быть длиннее 50 символов"),$("#flat_square").focus(),!1;var r=$("#flat_room_num").val();if(""===r||" "===r)return alert("Поле 'Количество комнат' не может быть пустым"),$("#flat_room_num").focus(),!1;if(!r.match(/^\d+$/))return alert("Поле 'Количество комнат' должно быть числом"),$("#flat_room_num").focus(),!1;var o=$("#flat_traffic").val();if(""===o||" "===o)return alert("Поле 'Общественный транспорт' не может быть пустым"),$("#flat_traffic").focus(),!1;if(o.length>300)return alert("Поле 'Общественный транспорт' не может быть длиннее 300 символов"),$("#flat_traffic").focus(),!1;var l=$("#flat_total_pay").val();if(""===l||" "===l)return alert("Поле 'Общая аренда' не может быть пустым"),$("#flat_total_pay").focus(),!1;if(!l.match(/^\d+$/))return alert("Поле 'Общая аренда' должно быть числом"),$("#flat_total_pay").focus(),!1;var n=$("#flat_rent_pay").val();if(""===n||" "===n)return alert("Поле 'Плата румейта' не может быть пустым"),$("#flat_rent_pay").focus(),!1;if(!n.match(/^\d+$/))return alert("Поле 'Плата румейта' должно быть числом"),$("#flat_rent_pay").focus(),!1;var s=$("#flat_enter_date").val();return s.match(/^\d{2}.\d{2}.\d{4}$/)?!0:(alert("Поле 'Дата въезда' заполнено неправильно"),$("#flat_enter_date").focus(),!1)}function hasFlat(){return""!==$("#flat_address").val()?!0:!1}function processInputSelect(e){var t=$("#"+e+">option"),a=t.eq(0).val();return t.each(function(){return $(this).prop("selected")?(a=$(this).val(),!1):void 0}),a}function enableAllControls(){}function disableAllControls(){}$(document).ready(function(){-1!==window.location.href.lastIndexOf("view")?handlersProfileView():-1!==window.location.href.lastIndexOf("edit")&&handlersProfileEdit()});